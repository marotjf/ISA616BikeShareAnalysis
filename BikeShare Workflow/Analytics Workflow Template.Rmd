---
title: "Analytics Workflow for BikeShare"
author: "John Marot"
output:
  html_document: default
  word_document: default
  toc: TRUE
  toc_float: TRUE
  number_sections: FALSE
  code_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE, 
                      warning = FALSE,
                      message = FALSE)
```

# Overview

Summary includes an overiew of the analysis and necessary references.

### For the first leg of value proposition (when to advertise, registered v casual)
* Classification analysis for which days attract most riders
* drill down on whether these are casual or registered riders

### For the second leg (How many bikes to put out each day to ease maintenance)
* multiple regression on number of riders at a given date/time

```{r, echo=FALSE}
## Manage Packages
if(require(pacman)==FALSE) install.packages("pacman")
pacman::p_load(readxl,fpp2,ggplot2,scales,dplyr, skimr, DataExplorer)
```

```{r, echo=FALSE}
#Reading in data
setwd("M:/ISA 616/ISA616BikeShareAnalysis/BikeShare Workflow")
bikeshare <- read.csv("Bike Share Data.csv", stringsAsFactors = TRUE)

#Splitting date and time column into a separate date column and numeric time column
bikeshare$Date <- sapply(strsplit(as.character(bikeshare$datetime), " "), "[", 1)
bikeshare$Time <- sapply(strsplit(as.character(bikeshare$datetime), " "), "[", 2)
bikeshare$Time <- sapply(strsplit(as.character(bikeshare$datetime), " "), "[", 2)
bikeshare$Date <- as.Date(bikeshare$datetime,format='%m/%d/%Y')
bikeshare$Time <- as.factor(bikeshare$Time)
bikeshare$Time <- as.numeric(bikeshare$Time)

#recoding other variables as factors 
bikeshare$season <- factor(bikeshare$season)
bikeshare$holiday <- factor(bikeshare$holiday)
bikeshare$workingday <- factor(bikeshare$workingday)
bikeshare$weather <- factor(bikeshare$weather)

#Removing original datetime column
library(dplyr)
bikeshare<-select(bikeshare, -datetime)
```

# Data Description

The source of this data set is the Capital BikeShare system which tracks bike sharing programs and includes relevant attributes such as seasonal and weather information and membership level. The data analyzed includes the total count of riders by hour and day, along with these additional attributes for bike rentals between the years 2011 and 2012.

* **Number of Observations:** _10,886_

*	**season:**
    + 1 = spring 
    + 2 = summer 
    + 3 = fall
    + 4 = winter. Categorical
*	**holiday:** whether the day is considered a holiday. Categorical. 2 levels
*	**workingday:** whether the day is neither a weekend nor holiday Categorical. 2 levels
*	**weather:** 
    + 1 = Clear, Few clouds, Partly cloudy, Partly cloudy 
    + 2 = Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist 
    + 3 = Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds
    + 4 = Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog 

*	**temp:** temperature in Celsius numerical
*	**atemp:** "feels like" temperature in Celsius numerical
*	**humidity:** relative humidity numerical
*	**windspeed:** wind speed numerical
*	**casual:** number of non-registered user rentals initiated numerical
*	**registered:** number of registered user rentals initiated
*	**count:** number of total rentals (Note that casual+registered=count, so you shouldnâ€™t use casual and registered to predict count. I have included the breakdown in case you wish to predict casual and registered with separate models.)
*	**date:** the current day, formatted as a date.
*	**time:** the current time (in hours) numerical

```{R} 
#DATA DESCRIPTION Code
source('data summary.R')
data.summary(bikeshare)

head(bikeshare)
tail(bikeshare)

```
# Preprocessing


* Details on data preprocessing are provided
* Feauture Generation: talk about creating dummies for multi level factors
* Imputation: No imputation because no missing values
* Outlier Removal: did not remove outliers yet (3% of data) because it is in second half of year, decent amount 
* Cleaning or merging of categories: had to split the date and time column earlier
* Anything that changes original form


```{R, echo=FALSE}
#Creating Dummy variables for multilevel Factors

dum<-as.data.frame(model.matrix(~0+bikeshare$season))
colnames(dum)<-c("spring", "summer", "fall", "winter")
bikeshare<-cbind(bikeshare, dum[,-1])


dum4<-as.data.frame(model.matrix(~0+bikeshare$weather))
colnames(dum4)<-c("Clear", "Mist", "Light Snow/Rain", "Heavy Rain/Snow")
bikeshare<-cbind(bikeshare, dum4[,-1])

bikeshare<-select(bikeshare, -season)
bikeshare<-select(bikeshare, -weather)

```

# Model Selection and Output

The first part of the analysis and model selection involved multiple regression analysis. This analysis was done so that the DownTown BikeSharing Company could more accurately predict the number of riders per day.

```{r}
#split into testing and validation
set.seed(13)
trainIndex = sample(1:nrow(bikeshare), size = round(0.7*nrow(bikeshare)), replace=FALSE)
head(trainIndex, 10)

bikeshare.train<-bikeshare[trainIndex, ]
bikeshare.valid<-bikeshare[-trainIndex, ]

```

```{r}
# Analysis of Total Count of Riders
#For this analysis we are looking at overall count. Therefore we need to take casual and registered out of the data frame for the analysis because count is the sum of these variables

bikeshare.train<-select(bikeshare.train, -registered)
bikeshare.train<-select(bikeshare.train, -casual)
bikeshare.valid<-select(bikeshare.valid, -registered)
bikeshare.valid<-select(bikeshare.valid, -casual)

#first fitting model with all variables entered. Needed to write it out long ways because cannot include registered and casual when predicting count
full<-lm(count~.,data=bikeshare.train)


#Next use stepwise function to create multiple regression for total Count
null<-lm(bikeshare.train$count~1, data=bikeshare.train)
lm.step<-step(null, scope=list(lower=null, upper=full), direction="both", trace=0)#trace=0 suppresses output.  Change trace=1 or 2 to get more
summary(lm.step)

#Evaluate Stepwise Multiple Regression Model for Total Count
library(forecast)
p.full<-predict(full, newdata=bikeshare.valid)
p.step<-predict(lm.step, newdata=bikeshare.valid)
head(p.full)


accuracy(p.step, bikeshare.valid$count)

```


```{r}
#Analysis for Registered Riders
set.seed(13)
trainIndex = sample(1:nrow(bikeshare), size = round(0.7*nrow(bikeshare)), replace=FALSE)
head(trainIndex, 10)

bikeshare.train<-bikeshare[trainIndex, ]
bikeshare.valid<-bikeshare[-trainIndex, ]
nrow(bikeshare.train)

bikeshare.train<-select(bikeshare.train, -count)
bikeshare.valid<-select(bikeshare.valid, -count)

full<-lm(registered~.,data=bikeshare.train)

summary(full)

null<-lm(bikeshare.train$registered~1, data=bikeshare.train)
lm.step<-step(null, scope=list(lower=null, upper=full), direction="both", trace=0)#trace=0 suppresses output.  Change trace=1 or 2 to get more
summary(lm.step)

#Evaluate Model

library(forecast)
p.full<-predict(full, newdata=bikeshare.valid)
p.step<-predict(lm.step, newdata=bikeshare.valid)
head(p.full)


accuracy(p.step, bikeshare.valid$registered)

```

```{r}
#Analysis for to predict # of casual riders

set.seed(13)
trainIndex = sample(1:nrow(bikeshare), size = round(0.7*nrow(bikeshare)), replace=FALSE)
head(trainIndex, 10)

bikeshare.train<-bikeshare[trainIndex, ]
bikeshare.valid<-bikeshare[-trainIndex, ]
nrow(bikeshare.train)

bikeshare.train<-select(bikeshare.train, -count)
bikeshare.valid<-select(bikeshare.valid, -count)

full<-lm(casual~.,data=bikeshare.train)

summary(full)

null<-lm(bikeshare.train$casual~1, data=bikeshare.train)
lm.step<-step(null, scope=list(lower=null, upper=full), direction="both", trace=0)#trace=0 suppresses output.  Change trace=1 or 2 to get more
summary(lm.step)

#Evaluate Model

library(forecast)
p.full<-predict(full, newdata=bikeshare.valid)
p.step<-predict(lm.step, newdata=bikeshare.valid)
head(p.full)


accuracy(p.step, bikeshare.valid$casual)

```


```{r}
#Regression Tree Analysis for When to advertise to casual riders

#split into testing and validation
set.seed(13)
trainIndex = sample(1:nrow(bikeshare), size = round(0.7*nrow(bikeshare)), replace=FALSE)
head(trainIndex, 10)

bikeshare.train<-bikeshare[trainIndex, ]
bikeshare.valid<-bikeshare[-trainIndex, ]
nrow(bikeshare.train)


bikeshare.train<-select(bikeshare.train, -count)
bikeshare.valid<-select(bikeshare.valid, -count)

#USING Denver B-Cycle for Money related analysis for the classification analysis
#about $1.50 in costs per trip
#Avg trips per annual member
#best days for casual riders to be out, so that you can send them promos to become registered member
library(rsample)     # data splitting 
library(dplyr)       # data wrangling
library(rpart)       # performing regression trees
library(rpart.plot)  # plotting regression trees
library(ipred)       # bagging
library(caret)       # bagging

m1 <- rpart(
  formula = casual ~ holiday + workingday + temp + humidity + windspeed + summer + fall + winter, 
  data    = bikeshare.train,
  method  = "anova"
)
rpart.plot(m1)

# Specify 10-fold cross validation
ctrl <- trainControl(method = "cv",  number = 10) 

# CV bagged model
bagged_cv <- train(
  casual ~ holiday + workingday + temp + humidity + windspeed + summer + fall + winter,
  data = bikeshare.train,
  method = "treebag",
  trControl = ctrl,
  importance = TRUE
)

# assess results
bagged_cv


# plot most important variables
plot(varImp(bagged_cv), 20)  

pred <- predict(bagged_cv, bikeshare.valid)
RMSE(pred, bikeshare.valid$casual)
#34.28095

#if temp >23, it is a workingday, and humidity is less than or equal to 56
#even if humidity is less than 71 still have avg of 91 riders
```
# Justification of anaysis

```{r}

```

# Conclusion

```{r}

```

## References

```{r}


```


