---
title: "Analytics Workflow for BikeShare"
author: "John Marot"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    number_sections: FALSE
    code_folding: hide
  word_document: default

---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE, 
                      warning = FALSE,
                      message = FALSE)
```

# Overview

Within this document I will detail the analysis that I have completed to assist the theoretical company DownTown Bikes (DTB). I have provided the company with a model to predict the the total count of bike rentals each day. My analysis also offers DTB the opportunity to drill down and predict the number of casual (non-registered) rentals per day, as well as what variables are most important in predicting this value. 

Due to maintenance costs and risk mitigation, it is advantageous for the DTB operations team to better predict the necessary amount of bikes to make available each day. To solve this problem, I utilized multiple regression analysis so that DTB can manage inventory more efficiently. Additionally, DTB's marketing team is attempting to convert more casual riders into registered riders. Using my model, the marketing team can better predict which days attract the most casual riders and tailor promotions based on this.


### Package Management and Loading Data
The below code contains package management using the library pacman. If pacman is required and is not yet installed, it will install the package. Then by using pacman one can call all the required packages and they will be the same version as used in this analysis.   

```{r}
if(require(pacman)==FALSE) install.packages("pacman")
pacman::p_load(readxl,fpp2,ggplot2,scales,dplyr, forecast, rsample, rpart, rpart.plot, ipred, caret, DT )

#Reading in data
setwd("M:/ISA 616/ISA616BikeShareAnalysis/BikeShare Workflow")
bikeshare <- read.csv("Bike Share Data.csv", stringsAsFactors = TRUE)
```

```{r, echo=FALSE}

bikeshare$Date <- sapply(strsplit(as.character(bikeshare$datetime), " "), "[", 1)
bikeshare$Time <- sapply(strsplit(as.character(bikeshare$datetime), " "), "[", 2)
bikeshare$Date <- as.Date(bikeshare$datetime,format='%m/%d/%Y')
bikeshare$Time <- as.factor(bikeshare$Time)
bikeshare$Time <- as.numeric(bikeshare$Time)

#recoding other variables as factors 
bikeshare$quarter <- factor(bikeshare$season)
bikeshare$holiday <- factor(bikeshare$holiday)
bikeshare$workingday <- factor(bikeshare$workingday)
bikeshare$weather <- factor(bikeshare$weather)

#Removing original datetime column
library(dplyr)
bikeshare<-select(bikeshare, -datetime)
bikeshare<-select(bikeshare, -season)
```

# Data Description

The source of this data set is the Capital BikeShare system which tracks over 500 different bike sharing programs and includes relevant attributes such as seasonal and weather information and membership status of riders. The data analyzed includes the total count of riders by hour and day, along with these additional attributes for bike rentals between the years 2011 and 2012.

* **Number of Observations:** _10,886_
* **Missing Observations:** _0_

### Variables

*	**datetime:** hourly date + timestamp. Categorical, but will need to be split into two diferent numerical variables

*	**season:**
    + 1 = spring 
    + 2 = summer 
    + 3 = fall
    + 4 = winter. Categorical. 4 levels
*	**holiday:** whether the day is considered a holiday. Categorical. 2 levels
*	**workingday:** whether the day is neither a weekend nor holiday. Categorical. 2 levels
*	**weather:** 
    + 1 = Clear, Few clouds, Partly cloudy, Partly cloudy 
    + 2 = Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist 
    + 3 = Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds
    + 4 = Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog. Categorical. 4 levels

*	**temp:** temperature in Celsius. Numerical
*	**atemp:** "feels like" temperature in Celsius. Numerical
*	**humidity:** relative humidity. Numerical
*	**windspeed:** wind speed. Numerical
*	**casual:** number of non-registered user rentals initiated. Numerical
*	**registered:** number of registered user rentals initiated. Numerical
*	**count:** number of total rentals initiated (casual + registered).  Numerical


The following code includes a call for a data summary function as well as the head and tail of the data set.

```{R} 
#Calling data summary function that is included within the github.
source('data summary.R')
data.summary(bikeshare)
```

##### Head of the data frame: 

```{R} 
DT::datatable(head(bikeshare, 10))
```

##### Tail of the data frame:

```{R} 
DT::datatable(tail(bikeshare, 10))
```

# Preprocessing

Within the pre-processing phase, there was feature generation for a couple multilevel factors including season and weather. In addition, there was some previous pre-processing done involving the date and time column. In the original data file there is a datetime attribute. To allow for better modeling I split these into two separate columns and deleted the original datetime attribute. The code for this step was included in previous steps so that the data summary would be more accurate. Additionally, I defined one of the original attributes, season, becasue it included misleading values that didn't line up to the seasons but instead to quarters of the year.

In terms of outlier removal, 3% of the observations were outliers. The outliers do not appear to be incorrectly measured data and do not affect model assumptions. Because of the relevance and variance provided from these observations I have decided to not eliminate the outliers.  


I have included in the code below the steps I took to create dummy variables for the multilevel factors. 

```{R}

#Creating Dummy variables for multilevel Factors

dum<-as.data.frame(model.matrix(~0+bikeshare$quarter))
colnames(dum)<-c("1Q", "2Q", "3Q", "4Q")
bikeshare<-cbind(bikeshare, dum[,-1])



dum1<-as.data.frame(model.matrix(~0+bikeshare$weather))
colnames(dum1)<-c("Clear", "Mist", "Light_SnowRain", "Heavy_SnowRain")
bikeshare<-cbind(bikeshare, dum1[,-1])

bikeshare<-select(bikeshare, -quarter)
bikeshare<-select(bikeshare, -weather)

```

# Model Selection and Output

The first part of the model selection involved multiple regression analysis. This analysis was done so that the DownTown BikeSharing Company could more accurately predict the number of riders per day. The goal of this analysis is to provide DownTown BikeSharing with a model that they can utilize to better manage bike placement and maintenance. 

The code below involves setting the seed and splitting the data into the training and validation set. 

```{r}
#split into testing and validation
set.seed(13)
trainIndex = sample(1:nrow(bikeshare), size = round(0.7*nrow(bikeshare)), replace=FALSE)

bikeshare.train<-bikeshare[trainIndex, ]
bikeshare.valid<-bikeshare[-trainIndex, ]

```

## Multiple Regression Analysis

### Predicting Total Count of Rentals

The first multiple regression model will be used to predict the overall count of riders, which is the sum of casual and registered rides. Therefore we need to take casual and registered out of the data frame for the analysis because they cannot be predictors for count. In addition to this, the data includes time variables such as date, time, and quarter. However, because of the length of the data it could not apply a time series to these values. Within my analysis I will focus on other variables not related to a time series analysis such as the type of day and other weather characteristics.   

```{r, echo=FALSE}
bikeshare.train<-select(bikeshare.train, -registered)
bikeshare.train<-select(bikeshare.train, -casual)

bikeshare.valid<-select(bikeshare.valid, -registered)
bikeshare.valid<-select(bikeshare.valid, -casual)

```

The below code includes the initial fitting of the model to all the available variables. The step-wise function then executes subsequently, using this full model as its upper range. Finally, the step-wise model outputs the optimal multiple regression equation and the values of the coefficients. 

```{r}
#First fitting model with all variables available in training set
full<-lm(count~ holiday+ workingday+ temp +atemp + humidity+ windspeed,data=bikeshare.train)



#Next using step-wise function to create multiple regression for total Count
null<-lm(bikeshare.train$count~1, data=bikeshare.train)
lm.step<-step(null, scope=list(lower=null, upper=full), direction="both", trace=0)

summary(lm.step)
```

The code and output below includes key metrics in which to evaluate the model on.

```{r}
#Model Evaluation
p.full<-predict(full, newdata=bikeshare.valid)
p.step<-predict(lm.step, newdata=bikeshare.valid)

accuracy(p.step, bikeshare.valid$count)


```
When looking at the evaluation metrics for the model predicting total count, one can see that there is an improvement 

### Predicting Count of Casual Rentals

```{r}
set.seed(13)
trainIndex = sample(1:nrow(bikeshare), size = round(0.7*nrow(bikeshare)), replace=FALSE)


bikeshare.train<-bikeshare[trainIndex, ]
bikeshare.valid<-bikeshare[-trainIndex, ]


bikeshare.train<-select(bikeshare.train, -count)
bikeshare.valid<-select(bikeshare.valid, -count)

full<-lm(casual~holiday+ workingday+ temp +atemp + humidity+ windspeed,data=bikeshare.train)


null<-lm(bikeshare.train$casual~1, data=bikeshare.train)
lm.step<-step(null, scope=list(lower=null, upper=full), direction="both", trace=0)
summary(lm.step)

```


```{r}
#Evaluate Model of Casual Count

library(forecast)
p.full<-predict(full, newdata=bikeshare.valid)
p.step<-predict(lm.step, newdata=bikeshare.valid)


accuracy(p.step, bikeshare.valid$casual)
```



## Regression Tree Analysis

### Predicting Count of Casual Rentals

```{r, echo=FALSE}
#split into testing and validation
set.seed(13)
trainIndex = sample(1:nrow(bikeshare), size = round(0.7*nrow(bikeshare)), replace=FALSE)


bikeshare.train<-bikeshare[trainIndex, ]
bikeshare.valid<-bikeshare[-trainIndex, ]

bikeshare.train<-select(bikeshare.train, -count)
bikeshare.valid<-select(bikeshare.valid, -count)

```

Creating regression tree algorithm.

```{r}

m1 <- rpart(
  formula = casual ~ holiday + workingday + temp + humidity + windspeed, 
  data    = bikeshare.train,
  method  = "anova"
)
rpart.plot(m1)
```
Cross validating the regression tree with the cv bagged model which allows me to cross validate among different subsets of the training data.


```{r}
#Validating the regression tree using the cv bagged model

ctrl <- trainControl(method = "cv",  number = 10) 

# CV bagged model
bagged_cv <- train(
  casual ~ holiday + workingday + temp + humidity + windspeed,
  data = bikeshare.train,
  method = "treebag",
  trControl = ctrl,
  importance = TRUE
)

# assess results
bagged_cv
```

Plotting the regressions tree determinance of importance among the different variables in the model.


```{r}
# plot most important variables
plot(varImp(bagged_cv), 20) 
```

As one can see, humidity, temperature, and workingday are the variables with the larest amount of importance within the regression tree analysis. Using this analysis to supplement the previous multiple regression analysis for the casual count will allow the marketing team at DownTown BikeSharing to understand exactly which days they should expect a large amount of casual bikers within the city. 


# Conclusion

In all, DownTown BikeSharing has the opportunity to utilize the mutiple regression models to improve upon maintenance and inventory planning. Using the overall count model, registered count, and casual count, DownTown BikeSharing can significantly decrease the RMSE when attempting to predict the amount of rentals when compared to a benchmark or full model. By using this model, Downtown BikeSharing can decide how many bikes to have available each day based on the predicted amount. This mitigates risk as to not have all the inventory on the streets every day. In addition, by not having the bikes out everyday, the company can perform maintenance during business hours. This will not only relieve the pain points of inventory management, but provide additional gains through cut costs.

When using the regression tree and analysis on the most important variables, the marketing team can then begin to extend ads to casual riders in hopes that they are riding on a day where these variable conditions are present. For instance, on a working day with mid temperatures and low humidity, one can expect on average the largest amount of casual bikers. Because of this, it may be beneficial to place digital ads on social media targeted at casual riders on these days.This will ultimately increase profit due to membership fees and will increase customer retention.






```{r}


```


